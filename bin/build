#!/usr/bin/env bash
#
# Build script for armrest mount STL files
# Uses OpenSCAD to render high-resolution STL output
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
SRC_FILE="$PROJECT_DIR/src/armrest_mount.scad"
BUILD_DIR="$PROJECT_DIR/build"

# Defaults
FN_RESOLUTION=150
SIDES="both"
STORAGE="true"
ANGLE=""
WIDTH=""
WIDTH_FRONT=""
THICKNESS=""
BUILD_MODE="all"  # all, mount, cover

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS]

Build armrest mount STL files using OpenSCAD.

Options:
  -s, --side SIDE       Which side to build: left, right, or both (default: both)
  -S, --storage         Enable storage compartment (default)
  -n, --no-storage      Disable storage compartment
  -m, --mount-only      Build only main mount pieces (no covers)
  -c, --cover-only      Build only front cover pieces (no mounts)
  -a, --angle DEGREES   Tenting angle in degrees (default: 20)
  -w, --width MM        Armrest width at back/closed end in mm (default: 96.0)
  -f, --width-front MM  Armrest width at front/open end in mm (default: 93.0)
  -t, --thickness MM    Armrest thickness in mm (default: 24.8)
  -r, --resolution N    Set \$fn resolution (default: 150)
  -h, --help            Show this help message

By default, builds both mounts and covers for the specified side(s).
Defaults are configured for the Flexispot C7 Pro Max chair armrests.

Examples:
  $(basename "$0")                    # Build all 4 pieces (both sides, mounts + covers)
  $(basename "$0") -s right           # Build right mount and right cover
  $(basename "$0") -m                 # Build only mounts (no covers)
  $(basename "$0") -c                 # Build only covers (no mounts)
  $(basename "$0") -s left -n         # Build left mount and cover without storage
  $(basename "$0") -a 15              # Build all with 15 degree tenting
  $(basename "$0") -w 90 -t 25        # Custom armrest dimensions
EOF
  exit 0
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    -s|--side)
      SIDES="$2"
      shift 2
      ;;
    -S|--storage)
      STORAGE="true"
      shift
      ;;
    -n|--no-storage)
      STORAGE="false"
      shift
      ;;
    -m|--mount-only)
      BUILD_MODE="mount"
      shift
      ;;
    -c|--cover-only)
      BUILD_MODE="cover"
      shift
      ;;
    -a|--angle)
      ANGLE="$2"
      shift 2
      ;;
    -w|--width)
      WIDTH="$2"
      shift 2
      ;;
    -f|--width-front)
      WIDTH_FRONT="$2"
      shift 2
      ;;
    -t|--thickness)
      THICKNESS="$2"
      shift 2
      ;;
    -r|--resolution)
      FN_RESOLUTION="$2"
      shift 2
      ;;
    -h|--help)
      usage
      ;;
    *)
      echo "Unknown option: $1"
      usage
      ;;
  esac
done

# Validate side option
if [[ "$SIDES" != "left" && "$SIDES" != "right" && "$SIDES" != "both" ]]; then
  echo "Error: --side must be 'left', 'right', or 'both'"
  exit 1
fi

# Create build directory if it doesn't exist
mkdir -p "$BUILD_DIR"

echo "Building armrest mount STL files..."
echo "Source: $SRC_FILE"
echo "Output: $BUILD_DIR"
echo "Resolution: \$fn=$FN_RESOLUTION"
echo "Side(s): $SIDES"
echo "Storage: $STORAGE"
echo "Building: $BUILD_MODE"
[[ -n "$ANGLE" ]] && echo "Angle: ${ANGLE}°"
if [[ -n "$WIDTH" || -n "$WIDTH_FRONT" ]]; then
  echo "Width: ${WIDTH_FRONT:-93.0}mm (front) → ${WIDTH:-96.0}mm (back)"
fi
[[ -n "$THICKNESS" ]] && echo "Thickness: ${THICKNESS}mm"
echo ""

build_piece() {
  local side="$1"
  local is_right="$2"
  local is_cover="$3"

  # Build filename
  local filename
  if [[ "$is_cover" == "true" ]]; then
    filename="armrest_cover_${side}"
  else
    filename="armrest_mount_${side}"
  fi
  [[ "$STORAGE" == "true" ]] && filename="${filename}_storage"
  [[ -n "$ANGLE" ]] && filename="${filename}_${ANGLE}deg"
  filename="${filename}.stl"

  if [[ "$is_cover" == "true" ]]; then
    echo "Building ${side} front cover..."
  else
    echo "Building ${side} mount..."
  fi

  # When building cover, set render_main=false so only cover is in STL
  local render_main="true"
  [[ "$is_cover" == "true" ]] && render_main="false"

  local cmd=(openscad -o "$BUILD_DIR/$filename"
    -D "is_right_armrest=$is_right"
    -D "enable_storage=$STORAGE"
    -D "preview_context=false"
    -D "render_main=$render_main"
    -D "render_cover=$is_cover"
    -D "\$fn=$FN_RESOLUTION")

  [[ -n "$ANGLE" ]] && cmd+=(-D "tenting_angle=$ANGLE")
  [[ -n "$WIDTH" ]] && cmd+=(-D "arm_width_back=$WIDTH")
  [[ -n "$WIDTH_FRONT" ]] && cmd+=(-D "arm_width_front=$WIDTH_FRONT")
  [[ -n "$THICKNESS" ]] && cmd+=(-D "arm_thickness=$THICKNESS")

  "${cmd[@]}" "$SRC_FILE"
  echo "  -> $filename"
}

# Build requested variants
# Order: all mounts first, then all covers

if [[ "$BUILD_MODE" == "all" || "$BUILD_MODE" == "mount" ]]; then
  if [[ "$SIDES" == "both" || "$SIDES" == "right" ]]; then
    build_piece "right" "true" "false"
  fi
  if [[ "$SIDES" == "both" || "$SIDES" == "left" ]]; then
    build_piece "left" "false" "false"
  fi
fi

if [[ "$BUILD_MODE" == "all" || "$BUILD_MODE" == "cover" ]]; then
  if [[ "$SIDES" == "both" || "$SIDES" == "right" ]]; then
    build_piece "right" "true" "true"
  fi
  if [[ "$SIDES" == "both" || "$SIDES" == "left" ]]; then
    build_piece "left" "false" "true"
  fi
fi

echo ""
echo "Build complete! Files in $BUILD_DIR:"
ls -lh "$BUILD_DIR"/*.stl 2>/dev/null || echo "(no STL files found)"
